# LTV Monthly Cohort Calculator

This command-line tool, written in Go, calculates the average monthly Customer Lifetime Value (LTV) for user cohorts. It connects to a MySQL database with a `datafy` schema, processes transactional data in memory, and outputs the results without relying on complex SQL joins.

---

## ðŸš€ Getting Started

### Prerequisites

- Go (version 1.18 or higher)
- A running MySQL or MariaDB server accessible to the application.

### Installation

1.  Clone this repository.
2.  Open your terminal in the project's root directory.
3.  Install the required Go module for the MySQL driver:
    ```sh
    go get github.com/go-sql-driver/mysql
    ```

### Execution

1.  First, build the executable file:
    ```sh
    go mod tidy
    go build -o ltv-monthly .
    ```
2.  Then, run the tool with the required command-line arguments:
    ```sh
    ./ltv-monthly --dsn="user:pass@host:port/dbname" --start_month="MMYYYY" --end_month="MMYYYY"
    ```

---

## ðŸ“‹ Command-Line Arguments

- `--dsn` (Required): The Data Source Name to connect to your MySQL database.
  - **Format**: `user:password@hostname:port/database_name`
- `--start_month` (Required): The first cohort month to calculate (inclusive).
  - **Format**: `MMYYYY` (e.g., `012025` for January 2025).
- `--end_month` (Required): The last cohort month to calculate (inclusive).
  - **Format**: `MMYYYY` (e.g., `082025` for August 2025).
- `-v` (Optional, default=true): Enable verbose mode for detailed logs.
  - **Format**: boolean (e.g., `false`).
- `-rro` (Optional, default=false): To calculate the Average LVT by the RunRamOptimized function.
  - **Format**: boolean (e.g., `true`).
- `-runWithInsertDateFromCustomerEvent` (Optional, default=false): To calculate the Average LVT using the CustomerEvent.InsertDate column.
  - **Format**: boolean (e.g., `true`).
- `-show_calculation_details` (Optional, default=false): display calculation details in the stdout.
  - **Format**: boolean (e.g., `true`).

#### Example

```sh
./ltv-monthly --dsn="root:secret@127.0.0.1:3306/datafy" --start_month="012025" --end_month="082025"
```

---

## âš™ï¸ Algorithm & Methodology

The application follows a **"Load -\> Compute in Memory"** architecture to efficiently process the data.

1.  **Connect & Load**: The tool connects to the database and loads all relevant order events from the `CustomerEventData` table into memory.
2.  **Aggregate Orders**: It processes the raw event data to reconstruct individual orders. The revenue for each item is taken directly from the price information stored within the `Digest` JSON column, ensuring historical accuracy.
3.  **Assign Cohorts**: By identifying the date of each customer's first-ever purchase, the tool assigns every customer to a specific monthly cohort.
4.  **Calculate LTV**: For each cohort, it sums the total revenue generated by all its members over their lifetime (up to the observation date) and divides it by the number of customers in that cohort.
5.  **Export Results**: The final LTV average for each cohort is printed to the standard output.

---

## ðŸ“‚ Project Structure

The project is organized into several packages to separate concerns:

- `main.go`: The entry point of the application. It handles command-line argument parsing, orchestrates the workflow, and prints the final results.
- `/pkg/database`: Contains `loader.go`, responsible for all database interactions, including establishing the connection and loading raw data.
- `/pkg/models`: Contains `types.go`, which defines the Go `structs` used to model the data.
- `/pkg/calculator`: Contains `ltv.go`, which houses the core business logic for aggregating orders, assigning cohorts, and calculating the LTV.
